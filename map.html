<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script>
    // Based on various pages on Google Maps Javascript API documentation except where noted otherwise

// Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see the error "The Geolocation service
// failed.", it means you probably did not give permission for the browser to
// locate you.

// Handle location updates
// From https://medium.com/risan/track-users-location-and-display-it-on-google-maps-41d1f850786e
const trackLocation = ({ onSuccess, onError = () => { } }) => {
    if ('geolocation' in navigator === false) {
      return onError(new Error('Geolocation is not supported by your browser.'));
    }
  
    // Use watchPosition for live updates
    return navigator.geolocation.watchPosition(onSuccess, onError);
};

var markers = []
var clicked;
var species = []
var dec_or_evg = []

// Taken from https://www.w3schools.com/js/js_cookies.asp
function getCookie(key) {
  var name = key + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  console.log("key is " + key)
  console.log("cookie is " + decodedCookie)
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
        console.log(JSON.parse(c.substring(name.length, c.length)).length)
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

const deleteMarkers = () => {
    console.log("in delete markers")
    // loop through markers, setting them to null on the map
    for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
    }
    console.log("removed " + markers.length + " markers")
    // set markers to an empty array
    markers = [];
}

const markers_in_bounds = () => {
    console.log("ran markers_in_bounds")
    // Get map bounds
    let bounds = map.getBounds()
    console.log(species);
    // Send AJAX request to server
    let url = '/getPins'
    $.ajax({
        url: url,
        type: "GET",
        contentType: "application/json",
        data: {bounds: JSON.stringify(bounds), species: JSON.stringify(species), dec_or_evg: JSON.stringify(dec_or_evg)},
        success: function(data){
            console.log(data)
            addMarkers(data.plants)
        }
    });
    // (server updates plants array with plants in range)
}

function handleResponse(response) {
    console.log("whatever")
}

$('#filter').submit(function(event) {
    event.preventDefault();

    // clear out previous filter regardless
    species = []
    dec_or_evg = []

    // uncheck all options if clear was clicked
    if (clicked === "Clear") {
        console.log("im here")
        $("#sel1 option:selected").prop("selected", false);
        $("#sel2 option:selected").prop("selected", false);
    }

    // only check for new values if apply was clicked
    if (clicked === "Apply") {
        species = $("#sel1 option:selected")
        species = $.makeArray(species)
        console.log("species: ")
        for (var i = 0; i < species.length; i++) {
            species[i] = species[i].value
            console.log(species[i])
        }
        dec_or_evg = $("#sel2 option:selected")
        dec_or_evg = $.makeArray(dec_or_evg)
        console.log("doe: ")
        for (var i = 0; i < dec_or_evg.length; i++) {
            dec_or_evg[i] = dec_or_evg[i].value
            console.log(dec_or_evg[i])
        }
    }

    document.cookie = "species=" + JSON.stringify(species)
    document.cookie = "dec_or_evg=" + JSON.stringify(dec_or_evg)

    deleteMarkers()
    markers_in_bounds()
});


const addMarkers = (plants) => {
    console.log("received " + plants.length + " plants")
    // place plants 
    var infowindow = new google.maps.InfoWindow();
    var contentString;
    for (var i = 0; i < plants.length; i++) {
        // console.log(plants[i])
        var lat = parseFloat(plants[i].lat);
        // console.log("lat: ", lat)
        // console.log("lng: ", lng)
        var lng = parseFloat(plants[i].lng);
        var title = plants[i].title;
        var titleURL = encodeURIComponent(title.trim());
        // console.log("title: " + title)
        // console.log(i, lat, lng);
        // console.log(titleURL)
        // console.log(plants[i].title)

        var marker = new google.maps.Marker({
            map: map,
            position: {
                lat: lat,
                lng: lng
            },
            title: title,
            clickable: true
        });

        // add marker to array
        markers.push(marker)

        google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {

                contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">'+
                plants[i].title+
                '</h1>'+
                '<div id="bodyContent">'+
                '<p><a href=plantdetails?common_name='+
                encodeURIComponent(plants[i].title.trim())+
                '>'+
                'Click here for more details</a></p>'+
                '</div>'+
                '</div>';
            
                infowindow.setContent(contentString);
                infowindow.open(map, marker);

            }
        })(marker, i));
    }
    console.log("added " + markers.length + " markers")
}
  
function initMap() {
    // console.log('{{plants | safe}}')
    // plants = '{{plants | safe}}'
    // console.log("plants in init: ", plants)
    // plants = JSON.parse(plants)

    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 40.3471, lng: -74.6566},
        zoom: 19,
        gestureHandling: "greedy"
    });
    locationMarker = new google.maps.Marker({
        map: map,
        icon: {
        //   url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        url: "/static/my_location.svg"
        }
    });
  
      // Call trackLocation
      // From https://medium.com/risan/track-users-location-and-display-it-on-google-maps-41d1f850786e
    trackLocation({
        onSuccess: ({ coords: { latitude: lat, longitude: lng } }) => {
            locationMarker.setPosition({ lat, lng });
            map.panTo({ lat, lng });
        },
        onError: err =>
            alert(`Error: Failed to obtain location`)
    });

    species = JSON.parse(getCookie('species'))
    dec_or_evg = JSON.parse(getCookie('dec_or_evg'))
    console.log(species.length)
    console.log(dec_or_evg.length)

    google.maps.event.addListenerOnce(map, "bounds_changed", function(){
        google.maps.event.addListener(map, "idle", function() { markers_in_bounds(0)});
    });

}
</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgPsCmJi55tXonvondJH9BCh7AOvDg3-8&callback=initMap">
</script>