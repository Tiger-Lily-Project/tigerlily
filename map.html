<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script>
    // Based on various pages on Google Maps Javascript API documentation except where noted otherwise

// Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see the error "The Geolocation service
// failed.", it means you probably did not give permission for the browser to
// locate you.

// Handle location updates
// From https://medium.com/risan/track-users-location-and-display-it-on-google-maps-41d1f850786e
const trackLocation = ({ onSuccess, onError = () => { } }) => {
    if ('geolocation' in navigator === false) {
      return onError(new Error('Geolocation is not supported by your browser.'));
    }
  
    // Use watchPosition for live updates
    return navigator.geolocation.watchPosition(onSuccess, onError);
};

var markers = []
var state = "index"

const deleteMarkers = () => {
    console.log("in delete markers")
    // loop through markers, setting them to null on the map
    for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
    }
    console.log("removed " + markers.length + " markers")
    // set markers to an empty array
    markers = [];
}

const markers_in_bounds = (reset, changeState) => {
    changeState = changeState || 0
    if (changeState == 0 && state === "tour") {
        tour()
        return
    }
    state = "index"
    console.log("ran markers_in_bounds")
    // Get map bounds
    let bounds = map.getBounds()
    console.log("bounds: ", bounds)
    console.log("reset: ", reset)

    // Send AJAX request to server
    let url = '/getPins'
    $.ajax({
        url: url,
        type: "GET",
        contentType: "application/json",
        data: {bounds: JSON.stringify(bounds), reset: reset},
        success: function(data){
            console.log(data)
            deleteMarkers()
            addMarkers(data.plants)
        }
    });
    // (server updates plants array with plants in range)
}

function handleResponse(response) {
    console.log("whatever")
}

const tour = () => {
    state = "tour"
    let ids = [572, 152, 3389, 3376, 3331, 656, 181, 271, 3260, 3485, 407, 874, 3109, 3906, 820, 3467, 793]
    let url = '/getTourPlants'
    $.ajax({
        url: url,
        type: "GET",
        contentType: "application/json",
        data: {ids: JSON.stringify(ids)},
        success: function(data) {
            console.log(data)
            deleteMarkers()
            addMarkers(data.plants)
            var coords = [
                {lat: 40.3494921, lng: -74.6602896},
                {lat: 40.3494185, lng: -74.6606088},
                {lat: 40.3485230, lng: -74.6602369},
                {lat: 40.348139, lng: -74.660083},
                {lat: 40.348133, lng: -74.660099},
                {lat: 40.348116, lng: -74.660107},
                {lat: 40.3477529, lng: -74.6606565},
                {lat: 40.347691, lng: -74.660620},
                {lat: 40.3477529, lng: -74.6606565},
                {lat: 40.347837, lng: -74.661163},
                {lat: 40.347643, lng: -74.661843},
                {lat: 40.347837, lng: -74.661163},
                {lat: 40.347715, lng: -74.660989},
                {lat: 40.347665, lng: -74.660869},
                {lat: 40.347368, lng: -74.661023},
                {lat: 40.347350, lng: -74.661001},
                {lat: 40.347327, lng: -74.660981},
                {lat: 40.346989, lng: -74.660790},
                {lat: 40.346740, lng: -74.660867},
                {lat: 40.346718, lng: -74.660780},
                {lat: 40.346692, lng: -74.660676},
                {lat: 40.345487, lng: -74.660211},
                {lat: 40.345530, lng: -74.660025},
                {lat: 40.345554, lng: -74.659973},
                {lat: 40.345921, lng: -74.659383},
                {lat: 40.345963, lng: -74.659328},
                {lat: 40.346004, lng: -74.659304},
                {lat: 40.346035, lng: -74.659306},
                {lat: 40.346095, lng: -74.659315},
                {lat: 40.346112, lng: -74.659321},
                {lat: 40.346128, lng: -74.659321},
                {lat: 40.346141, lng:-74.659318},
                {lat: 40.346376, lng: -74.659252},
                {lat: 40.346469, lng: -74.658849},
                {lat: 40.346433, lng: -74.658783},
                {lat: 40.346390, lng: -74.658768},
                {lat: 40.346383, lng: -74.658707},
                {lat: 40.346084, lng: -74.658347},
                {lat: 40.346059, lng: -74.658293},
                {lat: 40.346049, lng: -74.658250},
                {lat: 40.346045, lng: -74.658206},
                {lat: 40.346045, lng: -74.658153},
                {lat: 40.346053, lng: -74.658114},
                {lat: 40.346224, lng: -74.657457},
                {lat: 40.346347, lng: -74.657510},
                {lat: 40.346690, lng: -74.657401},
                {lat: 40.346719, lng: -74.657286},
                {lat: 40.346732, lng: -74.657168},
                {lat: 40.346719, lng: -74.657286},
                {lat: 40.346996, lng: -74.657282},
                {lat: 40.347193, lng: -74.657156},
                {lat: 40.347240, lng: -74.657078},
                {lat: 40.347236, lng: -74.657062},
                {lat: 40.347230, lng: -74.657037},
                {lat: 40.347230, lng: -74.657014},
                {lat: 40.347232, lng: -74.656997},
                {lat: 40.347303, lng: -74.656616}

            ]
            console.log(coords)
            var tourPath = new google.maps.Polyline({
	            path: coords
            });
            tourPath.setMap(map);
        }
    })
}

const addMarkers = (plants) => {
    console.log("received " + plants.length + " plants")
    // place plants 
    var infowindow = new google.maps.InfoWindow();
    var contentString;
    for (var i = 0; i < plants.length; i++) {
        // console.log(plants[i])
        var lat = parseFloat(plants[i].lat);
        // console.log("lat: ", lat)
        // console.log("lng: ", lng)
        var lng = parseFloat(plants[i].lng);
        var title = plants[i].title;
        var titleURL = encodeURIComponent(title.trim());
        // console.log("title: " + title)
        // console.log(i, lat, lng);
        // console.log(titleURL)
        // console.log(plants[i].title)

        if (state === "tour") {
            var marker = new google.maps.Marker({
                map: map,
                position: {
                    lat: lat,
                    lng: lng
                },
                title: title,
                label: (i + 1).toString(),
                clickable: true
            });
        } else {
            var marker = new google.maps.Marker({
                map: map,
                position: {
                    lat: lat,
                    lng: lng
                },
                title: title,
                clickable: true
            });
        }

        // add marker to array
        markers.push(marker)

        google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {

                contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">'+
                plants[i].title+
                '</h1>'+
                '<div id="bodyContent">'+
                '<p><a href=plantdetails?common_name='+
                encodeURIComponent(plants[i].title.trim())+
                '>'+
                'Click here for more details</a></p>'+
                '</div>'+
                '</div>';
            
                infowindow.setContent(contentString);
                infowindow.open(map, marker);
            }
        })(marker, i));
    }
    console.log("added " + markers.length + " markers")
}
  
function initMap() {
    // console.log('{{plants | safe}}')
    // plants = '{{plants | safe}}'
    // console.log("plants in init: ", plants)
    // plants = JSON.parse(plants)

    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 40.3471, lng: -74.6566},
        zoom: 17
    });
    locationMarker = new google.maps.Marker({
        map: map,
        icon: {
        //   url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        url: "/static/my_location.svg"
        }
    });
  
      // Call trackLocation
      // From https://medium.com/risan/track-users-location-and-display-it-on-google-maps-41d1f850786e
    trackLocation({
        onSuccess: ({ coords: { latitude: lat, longitude: lng } }) => {
            locationMarker.setPosition({ lat, lng });
            map.panTo({ lat, lng });
        },
        onError: err =>
            alert(`Error: Failed to obtain location`)
    });

    google.maps.event.addListenerOnce(map, "bounds_changed", function(){
        google.maps.event.addListener(map, "idle", function() { markers_in_bounds(0)});
    });

}
</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgPsCmJi55tXonvondJH9BCh7AOvDg3-8&callback=initMap">
</script>