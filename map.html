<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgPsCmJi55tXonvondJH9BCh7AOvDg3-8&callback=initMap">
    </script>
<script>

    // Handle location updates
    const trackLocation = ({ onSuccess, onError = () => { } }) => {

        if ('geolocation' in navigator === false) {
            return onError(new Error('Sorry, geolocation is not supported by your browser :('));
        }

        // Use watchPosition for live updates
        return navigator.geolocation.watchPosition(onSuccess, onError);
    };

    // If user allows us to ask for location
    function requestLocation() {
        console.log("requesting location")
        // Make sure panel and use location button are hidden
        var useLocationPanel = document.getElementById("useLocationPanel");
        useLocationPanel.classList.add("hidden");

        // Did the user just open the window or give location for the first time?
        var initializing = true
        console.log("initializing: ", initializing)

        trackLocation({
            onSuccess: ({ coords: { latitude: lat, longitude: lng } }) => {
                console.log("successful")
                locationMarker.setPosition({ lat, lng });
                if (initializing == true) {
                    map.panTo({ lat, lng });
                    initializing = false;
                }
                document.cookie = "geolocation=yes"
                var useLocationButton = document.getElementById("useLocationButton");
                useLocationButton.classList.add("hidden");
            },
            onError: err => {
                if (err.code == err.PERMISSION_DENIED) {
                    var useLocationButton = document.getElementById("useLocationButton");
                    useLocationButton.classList.add("hidden");
                    var locationInstructions = document.getElementById("locationInstructions");
                    locationInstructions.classList.remove("hidden");
                    console.log(err.message)
                } else { alert(err.message) }
                document.cookie = "geolocation=no"
            }
        });
    }

    function noLocationRequest() {
        // Remove panel
        var useLocationPanel = document.getElementById("useLocationPanel");
        useLocationPanel.classList.add("hidden");

        // Display button for user to allow location request
        var useLocationButton = document.getElementById("useLocationButton");
        useLocationButton.classList.remove("hidden");

        document.cookie = "geolocation=maybe"
    }

    // Show instructions for users to give us location permissions after denying them
    function showInstructions() {
        console.log("showing instructions")
        var instructionPanel = document.getElementById("instructionPanel");
        instructionPanel.classList.remove("hidden");
    }

    var markers = []
    var clicked;
    var species = []
    var dec_or_evg = []
    var selectedTree;

    const deleteMarkers = () => {
        console.log("in delete markers")
        // loop through markers, setting them to null on the map
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        console.log("removed " + markers.length + " markers")
        // set markers to an empty array
        markers = [];
    }

    const makeMarker = (plant, infoWindow) => {
        var contentString;

        var lat = parseFloat(plant.lat);
        var lng = parseFloat(plant.lng);
        var title = plant.title;
        var titleURL = encodeURIComponent(title.trim());

        var marker = new google.maps.Marker({
            map: map,
            position: {
                lat: lat,
                lng: lng
            },
            title: title,
            clickable: true
        });

        google.maps.event.addListener(marker, 'click', (function (marker) {
            return function () {

                contentString = '<div id="content">' +
                    '<div id="siteNotice">' +
                    '</div>' +
                    '<h1 id="firstHeading" class="firstHeading">' +
                    plant.title +
                    '</h1>' +
                    '<div id="bodyContent">' +
                    '<p><a href=plantdetails?common_name=' +
                    encodeURIComponent(plant.title.trim()) +
                    '>' +
                    'Click here for more details</a></p>' +
                    '</div>' +
                    '</div>';

                infowindow.setContent(contentString);
                infowindow.open(map, marker);
                selectedTree = marker;

                google.maps.event.addListener(map, "click", function (event) {
                    infowindow.close();
                });
            }
        })(marker));

        // Add to associative array of pins
        assocMarkers[plant.id_num] = marker;
    }

    const markers_in_bounds = (infoWindow) => {
        console.log("ran markers_in_bounds")
        // Get map bounds
        let bounds = map.getBounds()
        console.log(species);
        // Send AJAX request to server
        let url = '/getPins'
        $.ajax({
            url: url,
            type: "GET",
            contentType: "application/json",
            data: { bounds: JSON.stringify(bounds), species: JSON.stringify(species), dec_or_evg: JSON.stringify(dec_or_evg) },
            success: function (data) {
                console.log(data)
                markersByDensity(data.plants, bounds, infoWindow)
            }
        });
    }

    // handles filter
    $('#filter').submit(function (event) {
        event.preventDefault();

        // clear out previous filter regardless
        species = []
        dec_or_evg = []

        // uncheck all options if clear was clicked
        if (clicked === "Clear") {
            console.log("im here")
            $("#sel1 option:selected").prop("selected", false);
            $("#sel2 option:selected").prop("selected", false);
        }

        // only check for new values if apply was clicked
        if (clicked === "Apply") {
            species = $("#sel1 option:selected")
            species = $.makeArray(species)
            if (species.length > 50) {
                window.alert("Please select less than 50 species.");
                return;
            }
            console.log("species: ")
            for (var i = 0; i < species.length; i++) {
                species[i] = species[i].value
                console.log(species[i])
            }
            dec_or_evg = $("#sel2 option:selected")
            dec_or_evg = $.makeArray(dec_or_evg)
            console.log("doe: ")
            for (var i = 0; i < dec_or_evg.length; i++) {
                dec_or_evg[i] = dec_or_evg[i].value
                console.log(dec_or_evg[i])
            }

        }
        deleteMarkers()
        markers_in_bounds()

    });


    var assocMarkers = {}
    var ZONE_ROWS = 6
    var ZONE_COLS = 5
    var MAX_PINS_PER_ZONE = 2
    var TOTAL_MAX_PINS = ZONE_COLS * ZONE_ROWS * MAX_PINS_PER_ZONE

    // What zone is plant in given the zoneHeight and zoneWidth and the coordinates
    // of the northEast corner of the viewport?
    const calculateZone = (plant, zoneHeight, zoneWidth, northEast) => {
        var lat = parseFloat(plant.lat);
        var lng = parseFloat(plant.lng);
        var yIndex = Math.trunc(Math.abs(northEast.lat() - lat) / zoneHeight)
        var xIndex = Math.trunc(Math.abs(northEast.lng() - lng) / zoneWidth)
        var zone = (yIndex * ZONE_COLS) + (xIndex + 1)
        return zone
    }

    const markersByDensity = (plants, bounds) => {

        var northEast = bounds.getNorthEast()
        var southWest = bounds.getSouthWest()

        // Finds width and height of screen zones
        var zoneHeight = Math.abs((northEast.lat() - southWest.lat()) / ZONE_ROWS)
        var zoneWidth = Math.abs((northEast.lng() - southWest.lng()) / ZONE_COLS)
        console.log("zoneHeight: ", zoneHeight, ", zoneWidth: ", zoneWidth)

        console.log("received " + plants.length + " plants")

        var zoneDensities = []
        var zoneStacks = []
        for (var i = 1; i <= 30; i++) {
            zoneDensities[i] = 0;
            zoneStacks[i] = []
        }

        // If total pins in viewport is less than max total, show all regardless of zone
        // if (plants.length < TOTAL_MAX_PINS) {
        //     for (var i = 0; i < plants.length; i++) {
        //         makeMarker(plants[i])
        //         console.log("idNum in less than total: ", plants[i].id_num)
        //     }
        // }
        // Iterate through plant array to remove pins from overly-dense areas
        for (var i = 0; i < plants.length; i++) {
            var idNum = plants[i].id_num

            var zone = calculateZone(plants[i], zoneHeight, zoneWidth, northEast)

            // If zone at max density
            if (zoneDensities[zone] >= MAX_PINS_PER_ZONE) {
                if ((idNum in assocMarkers) && (selectedTree != assocMarkers[idNum])) {    // Remove pin if already displayed
                    console.log("delete plant ", idNum)
                    assocMarkers[idNum].setMap(null)
                    delete assocMarkers[idNum]
                    // console.log(assocMarkers)
                }
                continue
            }

            // If zone not at max density
            if (idNum in assocMarkers) {    // Leave pin if already displayed
                zoneDensities[zone]++
            } else {
                zoneStacks[zone].push(plants[i])   // If not add to stack for this zone
            }

        }

        // Iterate through zone stacks to add new pins by zone (or add all pins if there were fewer than max total plants in the first place)
        for (var i = 1; i <= (ZONE_COLS * ZONE_ROWS); i++) {
            if (zoneDensities[i] <= MAX_PINS_PER_ZONE) {
                if (zoneStacks[i].length >= 1) {    // If array is not empty
                    newPlant = zoneStacks[i].pop()
                    makeMarker(newPlant, infoWindow)
                    zoneDensities[i]++
                }
            }
        }
        console.log(assocMarkers)
    }

    // from w3schools docs for cookies in javascript
    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function initMap() {

        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 40.3471, lng: -74.6566 },
            zoom: 19,
            gestureHandling: "greedy"
        });
        locationMarker = new google.maps.Marker({
            map: map,
            icon: {
                url: "/static/my_location.svg",
                zIndex: google.maps.Marker.MAX_ZINDEX + 1
            }
        });
        locationMarker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1)

        var infowindow = new google.maps.InfoWindow();

        google.maps.event.addListenerOnce(map, "bounds_changed", function () {
            google.maps.event.addListener(map, "idle", function () { markers_in_bounds(infoWindow) });
        });

        var geoCookie = getCookie("geolocation");

        // Different options based on geolocation status
        if (geoCookie == "") {  // Show greeting panel if user hasn't made any decisions about geolocation
            var useLocationPanel = document.getElementById("useLocationPanel");
            useLocationPanel.classList.remove("hidden");
        } else if (geoCookie == "maybe") {  // Show button that asks for permissio if user didn't let us ask before
            var useLocationButton = document.getElementById("useLocationButton");
            useLocationButton.classList.remove("hidden");
        } else {    // Otherwise always request geolocation
            requestLocation()
        }
    }
</script>