<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script>
    // Based on various pages on Google Maps Javascript API documentation except where noted otherwise

// Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see the error "The Geolocation service
// failed.", it means you probably did not give permission for the browser to
// locate you.

// Handle location updates
// From https://medium.com/risan/track-users-location-and-display-it-on-google-maps-41d1f850786e
const trackLocation = ({ onSuccess, onError = () => { } }) => {
    if ('geolocation' in navigator === false) {
      return onError(new Error('Geolocation is not supported by your browser.'));
    }
  
    // Use watchPosition for live updates
    return navigator.geolocation.watchPosition(onSuccess, onError);
};

var markers = []
var lines = []
var tour_name = "";
var isDir;
var lastWindInd;
var lastPinInd;

var ptonTreesIds = [572, 152, 3389, 3376, 3331, 656, 181, 3260, 3485, 407, 874, 199, 3906, 820, 3467, 793];
var winterIds = [];

var ptonTreesCoords = [
                {lat: 40.3494921, lng: -74.6602896},
                {lat: 40.3494185, lng: -74.6606088},
                {lat: 40.3485230, lng: -74.6602369},
                {lat: 40.348139, lng: -74.660083},
                {lat: 40.348133, lng: -74.660099},
                {lat: 40.348116, lng: -74.660107},
                {lat: 40.3477529, lng: -74.6606565},
                {lat: 40.347691, lng: -74.660620},
                {lat: 40.3477529, lng: -74.6606565},
                {lat: 40.347837, lng: -74.661163},
                {lat: 40.347643, lng: -74.661843},
                {lat: 40.347837, lng: -74.661163},
                {lat: 40.347715, lng: -74.660989},
                {lat: 40.347665, lng: -74.660869},
                {lat: 40.347368, lng: -74.661023},
                {lat: 40.347350, lng: -74.661001},
                {lat: 40.347327, lng: -74.660981},
                {lat: 40.346989, lng: -74.660790},
                {lat: 40.346740, lng: -74.660867},
                {lat: 40.346718, lng: -74.660780},
                {lat: 40.346692, lng: -74.660676},
                {lat: 40.345487, lng: -74.660211},
                {lat: 40.345530, lng: -74.660025},
                {lat: 40.345554, lng: -74.659973},
                {lat: 40.345921, lng: -74.659383},
                {lat: 40.345963, lng: -74.659328},
                {lat: 40.346004, lng: -74.659304},
                {lat: 40.346035, lng: -74.659306},
                {lat: 40.346095, lng: -74.659315},
                {lat: 40.346112, lng: -74.659321},
                {lat: 40.346128, lng: -74.659321},
                {lat: 40.346141, lng:-74.659318},
                {lat: 40.346376, lng: -74.659252},
                {lat: 40.346469, lng: -74.658849},
                {lat: 40.346433, lng: -74.658783},
                {lat: 40.346390, lng: -74.658768},
                {lat: 40.346383, lng: -74.658707},
                {lat: 40.346084, lng: -74.658347},
                {lat: 40.346059, lng: -74.658293},
                {lat: 40.346049, lng: -74.658250},
                {lat: 40.346045, lng: -74.658206},
                {lat: 40.346045, lng: -74.658153},
                {lat: 40.346053, lng: -74.658114},
                {lat: 40.346224, lng: -74.657457},
                {lat: 40.346347, lng: -74.657510},
                {lat: 40.346690, lng: -74.657401},
                {lat: 40.346719, lng: -74.657286},
                {lat: 40.346882, lng: -74.657320},
                {lat: 40.346996, lng: -74.657282},
                {lat: 40.347193, lng: -74.657156},
                {lat: 40.347240, lng: -74.657078},
                {lat: 40.347236, lng: -74.657062},
                {lat: 40.347230, lng: -74.657037},
                {lat: 40.347230, lng: -74.657014},
                {lat: 40.347232, lng: -74.656997},
                {lat: 40.347330, lng: -74.656457},
                {lat: 40.347337, lng: -74.656462},
                {lat: 40.347344, lng: -74.656466},
                {lat: 40.347354, lng: -74.656471},
                {lat: 40.347366, lng: -74.656474},
                {lat: 40.347376, lng: -74.656474},
                {lat: 40.347381, lng: -74.656472},
                {lat: 40.347397, lng: -74.656468},
                {lat: 40.347408, lng: -74.656462},
                {lat: 40.347420, lng: -74.656451},
                {lat: 40.347427, lng: -74.656442},
                {lat: 40.347433, lng: -74.656433},
                {lat: 40.347438, lng: -74.656421},
                {lat: 40.347443, lng: -74.656411},
                {lat: 40.347445, lng: -74.656401},
                {lat: 40.347447, lng: -74.656386},
                {lat: 40.347448, lng: -74.656377},
                {lat: 40.347447, lng: -74.656364},
                {lat: 40.347445, lng: -74.656348},
                {lat: 40.347442, lng: -74.656338},
                {lat: 40.347439, lng: -74.656329},
                {lat: 40.347433, lng: -74.656315},
                {lat: 40.347424, lng: -74.656300},
                {lat: 40.347562, lng: -74.655686},
                {lat: 40.347610, lng: -74.655667},
                {lat: 40.347649, lng: -74.655661},
                {lat: 40.347676, lng: -74.655660},
                {lat: 40.347715, lng: -74.655661},
                {lat: 40.347787, lng: -74.655670},
                {lat: 40.347868, lng: -74.655905},
                {lat: 40.348240, lng: -74.656050},
                {lat: 40.348149, lng: -74.656325},
                {lat: 40.348134, lng: -74.656380},
                {lat: 40.347552, lng: -74.658796},
                {lat: 40.347959, lng: -74.658980},
                {lat: 40.348078, lng: -74.658564},
                {lat: 40.348563, lng: -74.658762},
                {lat: 40.348945, lng: -74.658946},
                {lat: 40.348921, lng: -74.659046},
                {lat: 40.348931, lng: -74.659056},
                {lat: 40.348972, lng: -74.659092},
                {lat: 40.349037, lng: -74.659169},
                {lat: 40.349076, lng: -74.659237},
                {lat: 40.349123, lng: -74.659340},
                {lat: 40.349203, lng: -74.659539},
                {lat: 40.349503, lng: -74.659356}
            ]
var winterCoords = []

var ptonDirs = [
    "Welcome to the Trees of Princeton tour! This tour begins in front of the Maclean House on Nassau Street. Make your way to pin #1 to begin the tour.",
    "The next tree on our tour is located behind Stanhope Hall. Head west on Nassau Street and turn left onto Elm Drive until you reach the building standing behind the Maclean House.",
    "Our next stop is in front of Buyers Hall, which stands to the left of the iconic Blair Arch.",
    "Walk towards the hall on the other side of Blair Arch, Blair Hall. The next tree on our tour stands near the archway to University Place.",
    "The next stop on our tour is Foulke Hall. Head down the steps of Blair Arch and continue south to pin #5.",
    "Continue south to the courtyard between Henry, Foulke, Laughlin, and 1901 Halls and to the next stop, in front of 1901 Hall.",
    "Head east past Dillon Gym to Cuyler Courtyard, located behind Brown Hall for the next stop on the tour.",
    "To continue the tour, head upcampus past the Class of 1975 Walk in Prospect Garden and towards Prospect House. Though our tour doesn't stop in Prospect Garden, feel free to pop in on your way!",
    "Continue towards Prospect House, where the next tree stands directly in front.",
    "Head through the roundabout onto Streiker Walk and into the courtyard standing in front of Frist Campus Center for the next stop.",
    "Continue upcampus, where the next tree stands at the intersection of McCosh Walk.",
    "Head east on McCosh Walk to the next tree, which stands behind the architecture building on your right.",
    "Keep walking on McCosh Walk to the Whig and Clio halls, marked by twin tiger statues. Walk up the stairs to see the next tree on our tour.",
    "Continue staight through the Whig and Clio halls and turn left. Turning left again on the perimeter of Cannon Green, the next tree is located to your right in front of a cone-like statue.",
    "Head straight to Nassau Hall, where the next tree stands just to the side of the building.",
    "For the last stop on our tour, head towards FitzRandolph Gate, where the last tree looms on the right before you reach the gate.",
    "Thank you for taking the Trees of Princeton tour! Select another tour above or navigate back to the home page to keep exploring."
    ]
var winterDirs = []

var ptonDirCoords = [
    {lat: 40.347647, lng: -74.659568},
    {lat: 40.349414, lng: -74.660612},
    {lat: 40.348302, lng: -74.660152},
    {lat: 40.347666, lng: -74.660875},
    {lat: 40.347699, lng: -74.661650},
    {lat: 40.346579, lng: -74.660630},
    {lat: 40.345498, lng: -74.660220},
    {lat: 40.346219, lng: -74.657465},
    {lat: 40.347238, lng: -74.657074},
    {lat: 40.347427, lng: -74.656274},
    {lat: 40.347874, lng: -74.655911},
    {lat: 40.348246, lng: -74.656050},
    {lat: 40.347941, lng: -74.657236},
    {lat: 40.347865, lng: -74.658942},
    {lat: 40.348331, lng: -74.658669},
    {lat: 40.349023, lng: -74.659156},
    {lat: 40.349490, lng: -74.659669}
]
var winterDirCoords = []

// Taken from https://www.w3schools.com/js/js_cookies.asp
function getCookie(key) {
  var name = key + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  console.log("key is " + key)
  console.log("cookie is " + decodedCookie)
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      result = c.substring(name.length, c.length)
      if (result === '"[]"') {
          return "[]"
      }
      return result;
    }
  }
  if (key === 'lastWindInd' || key === 'lastPinInd') {
      return 0;
  }
  return "";
}

const deleteMarkers = () => {
    console.log("in delete markers")
    // loop through markers, setting them to null on the map
    for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
    }
    console.log("removed " + markers.length + " markers")
    // set markers to an empty array
    markers = [];
}

function handleResponse(response) {
    console.log("whatever")
}

const tour = (tourName, isDir = true, lastWindInd = 0, lastPinInd = 0) => {
    tour_name = tourName;
    document.cookie = "tour_name=" + tour_name

    // remove tour from map if applicable
    if (lines.length > 0) {
        lines[0].setMap(null)
        deleteMarkers()
        lines = []
    }

    let url = '/getTourPlants'
    var coords;
    var ids;
    if (tour_name === 'pton') {
        ids = ptonTreesIds;
        coords = ptonTreesCoords;
    }
    if (tour_name === 'winter') {
        ids = winterIds;
        coords = winterCoords;
    }
    $.ajax({
        url: url,
        type: "GET",
        contentType: "application/json",
        data: {ids: JSON.stringify(ids)},
        success: function(data) {
            console.log(data)
            deleteMarkers()
            addMarkers(data.plants)
            console.log(markers.length)
            var tourPath = new google.maps.Polyline({
                path: coords,
                strokeColor: '#0080FF',
                strokeWeight: 3
            });
            tourPath.setMap(map);
            lines.push(tourPath)
            console.log("pushed tour")
        }
    })
    if (tour_name === 'pton') {
        ptonTreesTour(isDir, lastWindInd, lastPinInd);
    }
    if (tour_name === 'winter') {
        winterTour(isDir, lastWindInd, lastPinInd);
    }
    
}

const ptonTreesTour = (isDir, lastWindInd, lastPinInd) => {
    console.log("in tour")
    
    while (lastWindInd < ptonDirs.length) {
        if (isDir === true) {

            console.log("direction")

            var contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h4>' +
                ptonDirs[lastWindInd] +
                '</h4>' + 
                '<div id="bodyContent">' +
                '<p>Close out of this window when you\'re ready to move on!</p>' +
                '</div>' +
                '</div>';

            var infowindow = new google.maps.InfoWindow({
                content: contentString,
                position: ptonDirCoords[lastWindInd]
            });
            
            infowindow.open(map)
            /*
            console.log(infowindow.getMap())

            while (infowindow.getMap() !== null && lastWindInd != ptonDirs.length - 1) {

            }
            */
            lastWindInd++
            console.log(lastWindInd)
            console.log(ptonDirs.length)
            document.cookie = "lastWindInd=" + lastWindInd;
            isDir = false;
            document.cookie = "isDir=" + isDir;
        }
        else {
            console.log(markers)
            console.log(markers.length)
            var marker = markers[lastPinInd]

            console.log("pin")

            contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">'+
                marker.getTitle()+
                '</h1>'+
                '<div id="bodyContent">'+
                '<p><h5><a href=tourdetails?common_name='+
                encodeURIComponent(marker.getTitle().trim())+
                '&tour_name='+
                encodeURIComponent(tour_name.trim())+
                '>'+
                'Learn about this tree</a></h5></p>'+
                '<p>Close out of this window when you\'re ready to move on!</p>'
                '</div>'+
                '</div>';
            
            var infoWindow = new google.maps.InfoWindow({
                content: contentString
            });
            
            infoWindow.open(map, marker);
            /*
            console.log(infoWindow.getMap())

            while (infoWindow.getMap() !== null) {

            }
            */

            lastPinInd++
            document.cookie = "lastPinInd=" + lastPinInd;
            isDir = true;
            document.cookie = "isDir=" + isDir;

        }
    }
    tour_name = ""
    document.cookie = "tour_name=" + tour_name;
    isDir = true;
    document.cookie = "isDir=" + isDir;
    lastWindInd = 0;
    document.cookie = "lastWindInd=" + lastWindInd;
    lastPinInd;
    document.cookie = "lastPinInd=" + lastPinInd;
    
}

const addMarkers = (plants) => {
    console.log("received " + plants.length + " plants")
    // place plants 
    var infowindow = new google.maps.InfoWindow();
    var contentString;
    for (var i = 0; i < plants.length; i++) {
        // console.log(plants[i])
        var lat = parseFloat(plants[i].lat);
        // console.log("lat: ", lat)
        // console.log("lng: ", lng)
        var lng = parseFloat(plants[i].lng);
        var title = plants[i].title;
        var titleURL = encodeURIComponent(title.trim());
        // console.log("title: " + title)
        // console.log(i, lat, lng);
        // console.log(titleURL)
        // console.log(plants[i].title)

        var marker = new google.maps.Marker({
            map: map,
            position: {
                lat: lat,
                lng: lng
            },
            title: title,
            label: (i + 1).toString(),
            clickable: true
        });

        // add marker to array
        markers.push(marker)

        google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {

                contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">'+
                plants[i].title+
                '</h1>'+
                '<div id="bodyContent">'+
                '<p><h5><a href=tourdetails?common_name='+
                encodeURIComponent(plants[i].title.trim())+
                '&tour_name='+
                encodeURIComponent(tour_name.trim())+
                '>'+
                'Learn about this tree</a></h5></p>'+
                '<p>Close out of this window when you\'re ready to move on!</p>'
                '</div>'+
                '</div>';
            
                infowindow.setContent(contentString);
                infowindow.open(map, marker);

            }
        })(marker, i));
    }
    console.log("added " + markers.length + " markers")
}
  
function initMap() {
    console.log("initializing map")
    // console.log('{{plants | safe}}')
    // plants = '{{plants | safe}}'
    // console.log("plants in init: ", plants)
    // plants = JSON.parse(plants)

    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 40.3471, lng: -74.6566},
        zoom: 17
    });
    locationMarker = new google.maps.Marker({
        map: map,
        icon: {
        //   url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        url: "/static/my_location.svg"
        }
    });
  
      // Call trackLocation
      // From https://medium.com/risan/track-users-location-and-display-it-on-google-maps-41d1f850786e
    trackLocation({
        onSuccess: ({ coords: { latitude: lat, longitude: lng } }) => {
            locationMarker.setPosition({ lat, lng });
            map.panTo({ lat, lng });
        },
        onError: err =>
            alert(`Error: Failed to obtain location`)
    });

    tour_name = getCookie("tour_name")
    isDir = getCookie("isDir")
    if (isDir === "") {
        isDir = "true"
    }
    lastWindInd = parseInt(getCookie("lastWindInd"))
    lastPinInd = parseInt(getCookie("lastPinInd"))
    console.log(tour_name)
    console.log(isDir)
    console.log(lastWindInd)
    console.log(lastPinInd)

    if (tour_name !== "") {
        tour(tour_name, isDir, lastWindInd, lastPinInd)
    }



}
</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgPsCmJi55tXonvondJH9BCh7AOvDg3-8&callback=initMap">
</script>